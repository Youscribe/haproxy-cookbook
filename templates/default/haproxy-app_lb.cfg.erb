global
#        log 127.0.0.1   local0
#        log 127.0.0.1   local1 notice
        #log loghost    local0 info
  maxconn 30000
  #debug
  #quiet
  user haproxy
  group haproxy

defaults
#        log     global
#        option  httplog
#        option  dontlognull
#        retries 3
  maxconn 29500
  mode http
  option redispatch
  option http-server-close
  option abortonclose
#  option httpclose
  option tcp-smart-accept 
  option tcp-smart-connect

  option splice-auto

  balance leastconn

  timeout connect 5s
  timeout client 30s
  timeout server 10s
  timeout http-request 5s

  <% if node["haproxy"]["x_forwarded_for"] -%>
  option forwardfor
  <% end -%>

frontend http-in
  mode http
  bind :::<%= node["haproxy"]["incoming_port"] %>
  default_backend servers

<% if node["haproxy"]["enable_ssl"] -%>
frontend https-in
  mode tcp
  bind :::<%= node["haproxy"]["ssl_incoming_port"] %>
  default_backend servers-ssl
<% end -%>

backend servers
#  cookie MYSRV insert indirect nocache
  mode http
  <% if node["haproxy"]["httpchk"] -%>
  option httpchk <%= node["haproxy"]["httpchk"] %>
  <% end -%>
  <% @pool_members.each do |member| -%>
  server <%= member[:hostname] %> <%= member[:ipaddress] %>:<%= node["haproxy"]["member_port"] %> maxconn <%= node["haproxy"]["member_max_connections"] %> check
  <% end -%>

backend servers-ssl
  mode tcp
  option ssl-hello-chk
  <% @pool_members.each do |member| -%>
  server <%= member[:hostname] %> <%= member[:ipaddress] %>:<%= node["haproxy"]["ssl_member_port"] %> maxconn <%= node["haproxy"]["member_max_connections"] %> check
  <% end -%>

<% if node["haproxy"]["enable_admin"] -%>
listen admin 127.0.0.1:22002
  mode http
  stats uri /
<% end -%>
